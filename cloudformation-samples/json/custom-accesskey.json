{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "NorthBay Labs cfn-custom-resources Custom::AccessKey sample template.",
    "Parameters": {
        "CustomResourcesFunction": {
            "Description": "The Lambda function name of the NorthBay Labs custom resources provider. Defaults to CFNCustomResourcesFunction.",
            "Type": "String",
            "Default": "CFNCustomResourcesFunction"
        },
        "Environment": {
            "Type": "String",
            "Default": "dev"
        },
        "KmsKeyId": {
            "Description": "KMS Key ID, alias, or ARN to use to do the encryption when stored in the Parameter Store. Set to an empty string to use the default KMS Key. Default is no KMS Key ID (empty string).",
            "Type": "String",
            "Default": ""
        },
        "ReturnSecret": {
            "Description": "If true will return SecretKey. Default is true.",
            "Type": "String",
            "Default": true,
            "AllowedValues": [
                true,
                false
            ]
        },
        "ReturnSmtpPassword": {
            "Description": "If true will return SES SMTP password. Default is true.",
            "Type": "String",
            "Default": true,
            "AllowedValues": [
                true,
                false
            ]
        },
        "RotateOnUpdate": {
            "Description": "If true will generate a new Access Key on update. Default is false.",
            "Type": "String",
            "Default": false,
            "AllowedValues": [
                true,
                false
            ]
        },
        "UserName": {
            "Description": "The IAM user to create an AccessKey for.",
            "Type": "String",
            "Default": "test-user1"
        }
    },
    "Resources": {
        "AccessKey": {
            "Type": "Custom::AccessKey",
            "Properties": {
                "Description": "AccessKey Generated by cfn-custom-resources",
                "KmsKeyId": {
                    "Ref": "KmsKeyId"
                },
                "NoEcho": true,
                "ReturnSecret": {
                    "Ref": "ReturnSecret"
                },
                "ReturnSmtpPassword": {
                    "Ref": "ReturnSmtpPassword"
                },
                "RotateOnUpdate": {
                    "Ref": "RotateOnUpdate"
                },
                "SecretPath": {
                    "Fn::Sub": "/northbaylabs/${Environment}/accesskey/${UserName}"
                },
                "ServiceToken": {
                    "Fn::Sub": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${CustomResourcesFunction}-${Environment}"
                },
                "UserName": {
                    "Ref": "UserName"
                },
                "Tags": [
                    {
                        "Key": "ENV",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "AccessKeyId": {
            "Description": "The AccessKeyID of the created Access Key.",
            "Value": {
                "Fn::GetAtt": [
                    "AccessKey",
                    "AccessKeyId"
                ]
            }
        },
        "SecretAccessKey": {
            "Description": "The SecretAccessKey of the created Access Key in plaintext.",
            "Value": {
                "Fn::GetAtt": [
                    "AccessKey",
                    "SecretAccessKey"
                ]
            }
        },
        "SecretPath": {
            "Description": "The path where the Access Key information is stored in the SSM Parameter Store.",
            "Value": {
                "Fn::GetAtt": [
                    "AccessKey",
                    "SecretPath"
                ]
            }
        },
        "SmtpPassword": {
            "Description": "The SES SMTP password in plaintext.",
            "Value": {
                "Fn::GetAtt": [
                    "AccessKey",
                    "SmtpPassword"
                ]
            }
        }
    }
}